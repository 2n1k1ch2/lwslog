name: CI

on: [push, pull_request]

jobs:
  build-and-lint:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false
      
      - name: Install latest GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-13 g++-13
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 100
          
      - name: Build project
        run: |
          mkdir -p build
          cd build
          cmake ..
          make -j4
          
      - name: Find and check source files
        run: |
          echo "Поиск файлов в: $(pwd)"
          FILES=$(find . -name "*.cpp" -o -name "*.h" -o -name "*.hpp" | grep -v "external" | grep -v "asio")
          echo "Найдено файлов: $(echo "$FILES" | wc -l)"
          echo "$FILES" | head -5
          
      - name: Run clang-tidy
        run: |
          find . -name "*.cpp" -o -name "*.h" -o -name "*.hpp" | \
          grep -v "external" | \
          grep -v "asio" | \
          xargs -I {} sh -c 'echo "Checking: {}"; clang-tidy {} -p build/ -- -std=c++20 -Iinc || true'